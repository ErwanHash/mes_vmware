# déclencher le playbook :
# ansible-playbook premier_playbook.yml -b --ask-become-pass
---
- hosts: localhost

  tasks:
    - name : Include secret items
      include_vars:
        file: secrets.yml
        name: secret

    - name: ajouter un groupe de ports sur le vSwitch0 avec un ID de VLAN
      community.vmware.vmware_portgroup:
        hosts: esxi1.formation.lan, esxi2.formation.lan, esxi3.formation.lan
        hostname: vcsa.formation.lan
        username: erwan
        password: F0rmation!
        switch: vSwitch0
        portgroup_name: VLAN_Erwan
        network_policy:
            promiscuous_mode: True
        vlan_id: 0100
        validate_certs: no
        state: present

    - name: Create a tag
      community.vmware.vmware_tag:
        hostname: vcsa.formation.lan
        username: erwan
        password: F0rmation!
        category_id: urn:vmomi:InventoryServiceCategory:ae1957ef-839b-468c-ac6a-df722535aeb1:GLOBAL
        tag_name: Erwan
        tag_description: Tag de moi
        state: present
        validate_certs: no
      delegate_to: localhost

    # - name: Get category id from the given tag
    #   vmware_tag_facts:
    #     hostname: vcsa.formation.lan
    #     username: erwan
    #     password: F0rmation!
    #     validate_certs: no
    #   register: tag_details

    # - debug:
    #     msg: "{{ tag_details.tag_facts }}"

    - name: Create a virtual machine from a template
      community.vmware.vmware_guest:
        validate_certs: no
        hostname: vcsa.formation.lan
        username: erwan
        password: F0rmation!
        datacenter: Datacenter
        folder: /
        name: Deb_Erwan
        state: poweredon
        template: DebTemplate
        disk:
        - size_gb: 5
          type: thin
          autoselect_datastore: yes
        wait_for_ip_address: true
      delegate_to: localhost
      register: deploy

    - name: ajout du tag Erwan dans la catégorie Proprio
      community.vmware.vmware_tag_manager:
        hostname: vcsa.formation.lan
        username: erwan
        password: F0rmation!
        tag_names:
          - Erwan
        state: add
        object_name: Deb_Erwan
        object_type: VirtualMachine
        validate_certs: no
      delegate_to: localhost

...